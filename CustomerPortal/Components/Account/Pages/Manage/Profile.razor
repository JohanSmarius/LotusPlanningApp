@page "/Account/Manage/profile"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using LotusPlanningApp.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Profile</PageTitle>

<h3>Profile</h3>
<StatusMessage Message="@statusMessage" />

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Personal Information</h5>
            </div>
            <div class="card-body">
                <EditForm Model="Input" method="post" OnValidSubmit="OnValidSubmitAsync" FormName="profile">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" role="alert" />

                    <div class="mb-3">
                        <label for="firstname" class="form-label">First Name</label>
                        <InputText @bind-Value="Input.FirstName" class="form-control" id="firstname" />
                        <ValidationMessage For="() => Input.FirstName" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label for="lastname" class="form-label">Last Name</label>
                        <InputText @bind-Value="Input.LastName" class="form-control" id="lastname" />
                        <ValidationMessage For="() => Input.LastName" class="text-danger" />
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <InputText @bind-Value="Input.Email" class="form-control" id="email" disabled />
                    </div>

                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <InputText @bind-Value="username" class="form-control" id="username" disabled />
                    </div>

                    @if (user?.StaffId.HasValue ?? false)
                    {
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Linked Staff Member:</strong> Staff ID #@user.StaffId
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-circle me-2"></i>
                            <strong>Not yet linked:</strong> Your account is not yet linked to a staff member.
                        </div>
                    }

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Update Profile
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private ApplicationUser? user;
    private string? username;
    private string? statusMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserManager.GetUserAsync(HttpContext.User);
        if (user == null)
        {
            RedirectManager.RedirectTo("Account/Login");
            return;
        }

        username = await UserManager.GetUserNameAsync(user);
        Input.Email = user.Email ?? "";
        Input.FirstName = user.FirstName ?? "";
        Input.LastName = user.LastName ?? "";
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.FirstName != user?.FirstName)
        {
            user!.FirstName = Input.FirstName;
        }

        if (Input.LastName != user?.LastName)
        {
            user!.LastName = Input.LastName;
        }

        var result = await UserManager.UpdateAsync(user!);

        if (!result.Succeeded)
        {
            statusMessage = "Error: Unable to update profile.";
            return;
        }

        await SignInManager.RefreshSignInAsync(user!);
        statusMessage = "Your profile has been updated successfully.";
    }

    private sealed class InputModel
    {
        [Display(Name = "First name")]
        [StringLength(50)]
        public string FirstName { get; set; } = "";

        [Display(Name = "Last name")]
        [StringLength(50)]
        public string LastName { get; set; } = "";

        [EmailAddress]
        public string Email { get; set; } = "";
    }
}
